<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Редактор PDF</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    .toolbar {
      margin-bottom: 15px;
    }
    .toolbar button, .toolbar select, .toolbar input {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>Редактирование PDF</h2>

  <div class="toolbar">
    <input type="file" id="pdf-upload" accept="application/pdf">
    <button onclick="addText()">Добавить текст</button>
    <button onclick="setEraser()">Ластик</button>
    <input type="color" id="colorPicker" value="#000000">
    <button onclick="addImage()">Добавить картинку</button>
    <input type="file" id="image-upload" accept="image/*" style="display:none;">
    <button onclick="savePDF()">Сохранить PDF</button>
  </div>

  <canvas id="pdf-canvas"></canvas>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const canvasEl = document.getElementById("pdf-canvas");
    const fabricCanvas = new fabric.Canvas('pdf-canvas');
    const pdfInput = document.getElementById('pdf-upload');
    const imageInput = document.getElementById('image-upload');
    const colorPicker = document.getElementById('colorPicker');

    let currentPdfPage = null;

    // Загрузка PDF и отрисовка первой страницы
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async () => {
        const typedArray = new Uint8Array(reader.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.5 });

        const tempCanvas = document.createElement('canvas');
        const context = tempCanvas.getContext('2d');
        tempCanvas.width = viewport.width;
        tempCanvas.height = viewport.height;

        await page.render({ canvasContext: context, viewport }).promise;

        fabricCanvas.setWidth(viewport.width);
        fabricCanvas.setHeight(viewport.height);

        const img = new Image();
        img.src = tempCanvas.toDataURL();
        img.onload = () => {
          const fabricImg = new fabric.Image(img, { selectable: false, evented: false });
          fabricCanvas.setBackgroundImage(fabricImg, fabricCanvas.renderAll.bind(fabricCanvas));
        };

        currentPdfPage = page;
      };
      reader.readAsArrayBuffer(file);
    });

    // Добавление текста
    function addText() {
      const text = new fabric.IText('Введите текст', {
        left: 50,
        top: 50,
        fill: colorPicker.value,
        fontSize: 20
      });
      fabricCanvas.add(text);
      fabricCanvas.setActiveObject(text);
    }

    // Ластик (рисует белым)
    function setEraser() {
      fabricCanvas.isDrawingMode = true;
      fabricCanvas.freeDrawingBrush.color = "#ffffff";
      fabricCanvas.freeDrawingBrush.width = 20;
    }

    // Добавление изображения
    function addImage() {
      imageInput.click();
    }

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function () {
        fabric.Image.fromURL(reader.result, function (img) {
          img.set({ left: 100, top: 100, scaleX: 0.5, scaleY: 0.5 });
          fabricCanvas.add(img);
        });
      };
      reader.readAsDataURL(file);
    });

    // Сохранение в PDF
    async function savePDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', [fabricCanvas.width, fabricCanvas.height]);
      const dataUrl = fabricCanvas.toDataURL({ format: 'png' });
      pdf.addImage(dataUrl, 'PNG', 0, 0, fabricCanvas.width, fabricCanvas.height);
      pdf.save('редактированный.pdf');
    }
  </script>
</body>
</html>

